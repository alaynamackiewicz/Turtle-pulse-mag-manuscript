---
title: "Magnetite-based mechanism underlies sea turtle map sense"
output: html_document
date: "2024-12-31"
---

################################################################################
#Load Libraries
```{r}
library(RColorBrewer)
library(plyr)
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(rstatix)
library(ggsignif)
library(outliers)
library(maps)
library(TOSTER)
```

################################################################################
#Color Palette
```{r}
#display.brewer.pal(8, "BuPu")
#brewer.pal(n = 8, name = "BuPu") #Hexadecimal color specification 

#rewarded "#6E016B"
#unrewarded "#6E016B"

#no pulse "#6E016B"
#sham "#88419D"
#pulse "#8C96C6"
```

################################################################################
#Pulse Mag Data
```{r}
cond_data <- read.csv("2024_12_31 Conditioning Analysis.csv", sep = ",", header = TRUE)
#View(cond_data)

pulsemag_data <- read.csv("2024_12_31 Turtle Pulse Mag Analysis.csv", sep = ",", header = TRUE)
#View(pulsemag_data)
```

##Arrange Data by Treatment and Turtle_ID
```{r}
cond_data <- cond_data %>% arrange(Treatment)
cond_data <- cond_data %>% arrange(desc(Turtle_ID))

pulsemag_data <- pulsemag_data %>% arrange(Treatment)
pulsemag_data <- pulsemag_data %>% arrange(desc(Turtle_ID))
```

##Outlier Testing
if p-value < 0.05, then value is an outlier
```{r}
no_pulse <- pulsemag_data %>% filter(Treatment== "No Pulse")
dixon.test(no_pulse$Avg_Time)
#p-value = 0.39

sham_pulse <- pulsemag_data %>% filter(Treatment== "Sham Pulse")
dixon.test(sham_pulse$Avg_Time)
#p-value = 0.624

pulse <- pulsemag_data %>% filter(Treatment== "Pulse")
dixon.test(pulse$Avg_Time)
#p-value < 2.2e-16
#alternative hypothesis: highest value 72.8 is an outlier

```

#Calculating Percentage Change
```{r}
sham_perc_change_data <- pulsemag_data %>%
  group_by(Turtle_ID) %>%
  summarize(
    No_Pulse = Avg_Time[Treatment == "No Pulse"],
    Sham_Pulse = Avg_Time[Treatment == "Sham Pulse"],
    Percent_Change = ((Sham_Pulse - No_Pulse) / No_Pulse) * 100
  )

sham_perc_change_data <- sham_perc_change_data %>% mutate(Comparison="Sham Pulse") #adding comparison descriptor to plot

sham_perc_change_data <- sham_perc_change_data %>% select(Turtle_ID, Percent_Change, Comparison) #getting rid of no pulse and pulse columns to merge data sets together

#sham_perc_change_data
```

```{r}
pulse_perc_change_data <- pulsemag_data %>%
  group_by(Turtle_ID) %>%
  summarize(
    No_Pulse = Avg_Time[Treatment == "No Pulse"],
    Pulse = Avg_Time[Treatment == "Pulse"],
    Percent_Change = ((Pulse - No_Pulse) / No_Pulse) * 100
  )

pulse_perc_change_data<- pulse_perc_change_data %>% mutate(Comparison="Pulse") #adding comparison descriptor to plot

pulse_perc_change_data <- pulse_perc_change_data %>% select(Turtle_ID, Percent_Change, Comparison) #getting rid of no pulse and pulse columns to merge data sets together

#pulse_perc_change_data
```

##Combining Percent Change Dataframes
```{r}
perc_change_data <- rbind(sham_perc_change_data, pulse_perc_change_data)
#perc_change_data
```

################################################################################
#Percentage Change Plotting
#Figure 1C
```{r}
pulse_boxplot <- ggplot(perc_change_data,aes(x=Comparison,y=Percent_Change,fill=Comparison)) + 
   geom_segment(aes(x=0,xend=3,y=1,yend=1), linetype=2, color = "grey") +
  geom_boxplot(width = 0.7, outlier.shape = NA) + geom_point(size=3.5, position=position_jitter(width = 0.2)) + 
  theme_classic() + 
  theme(axis.title.x = element_blank(), axis.title.y = element_text(size=12), 
        axis.text.x = element_text(size = 12, color = "black"), 
        axis.text.y = element_text(size = 12, color = "black")) +
  labs (x="Treatment", y="Change in food-seeking behavior \n relative to no pulse (%)") + 
  scale_fill_manual(values=c("#8C96C6","#88419D")) + 
  theme(legend.position = "none") + 
  scale_x_discrete(limits=c("Sham Pulse", "Pulse"), labels=c("Sham Pulse" = "Sham pulse"), expand = c(0, 0)) +
  scale_y_continuous(expand = c(0,0),limits = c(-100,320)) +
  annotate("text", x = c(2),y = c(290.5),label = c("***"), size=8)

pulse_boxplot
ggsave("Fig1C.pdf", width=4, height=6, dpi=300)
ggarrange(pulse_boxplot, labels =  c("C"), ncol = 1, nrow = 1, align = "h")
ggsave("Fig1C.pdf", width=4, height=6, dpi=300)
```

##Statistical Analysis
Determine if the median of a single sample is significantly different from a specified value (mu = 0)
```{r}
wilcox.test(sham_perc_change_data$Percent_Change, mu = 0, alternative = "less") #sham pulse percent change compared to no pulse is not less than 0
#p-value = 0.55
wilcox.test(pulse_perc_change_data$Percent_Change, mu = 0, alternative = "less") #pulse percent change compared to no pulse is signficantly less than 0
#p-value = 0.0003815
```

```{r}
wilcox_test(Percent_Change ~ Comparison, data = perc_change_data, paired= TRUE) #significantly difference in percent change between sham pulse and pulse
compare_means(Percent_Change ~ Comparison, data = perc_change_data, paired= TRUE)
#p-value = 0.0052
```

##Wilcoxon TOST Equivalence Test
```{r}
TOST_sham_perc <- (sham_perc_change_data$Percent_Change)
TOST_sham_perc <- as.numeric(TOST_sham_perc)

TOST_pulse_perc <- (pulse_perc_change_data$Percent_Change)
TOST_pulse_perc <- as.numeric(TOST_pulse_perc)

mean(TOST_sham_perc)#23.07
mean(TOST_pulse_perc) #-41.87

# Run paired equivalence test
TOSTpaired(n = length(TOST_sham_perc),
           m1 = mean(TOST_sham_perc), 
           m2 = mean(TOST_pulse_perc),  
           sd1 = sd(TOST_sham_perc), 
           sd2 = sd(TOST_pulse_perc), 
           r12 = cor(TOST_sham_perc, TOST_pulse_perc),  # Correlation between paired samples
           low_eqbound = -23,
           high_eqbound = 23,  
           alpha = 0.05)

```

################################################################################
#Map Assay Conditioning  Data
```{r}
cond_data <- read.csv("2024_12_31 Conditioning Analysis.csv", sep = ",", header = TRUE)
#View(cond_data)
```

##Arrange Data by Treatment and Turtle_ID
```{r}
cond_data <- cond_data %>% arrange(Treatment)
cond_data <- cond_data %>% arrange(desc(Turtle_ID))
```

###Outlier Testing
```{r}
rewarded <- cond_data %>% filter(Treatment== "Rewarded")
dixon.test(rewarded$Avg_Time)
#p-value = 0.3304

unrewarded <- cond_data %>% filter(Treatment== "Unrewarded")
dixon.test(unrewarded$Avg_Time)
#-value = 0.0119
#alternative hypothesis: highest value 72.24 is an outlier
```

################################################################################
#Map Assay Conditioning Plotting
##Figure S1
```{r}
cond_barplot <- ggplot(cond_data,aes(x=Treatment,y=Avg_Time,fill=Treatment)) + 
  stat_summary(fun="mean",geom="bar") + 
  stat_summary(fun=mean,fun.min = function(x) mean(x)-sd(x)/sqrt(length(x)),fun.max = function(x) mean(x) + 
  sd(x)/sqrt(length(x)), geom="errorbar",color="black", width=0.6) + 
  geom_point(position=position_jitter(width=0.2),size=3.5) + theme_classic() + 
  theme(axis.title.x = element_blank(), axis.title.y = element_text(size=12), 
        axis.text.x = element_text(size = 12, color = "black"), 
        axis.text.y = element_text(size = 12, color = "black")) +
  labs (y="Time exhibiting food-seeking \n behavior (s)") + 
  scale_fill_manual(values=c("#6E016B", "#6E016B")) + 
  theme(legend.position = "none") +
  scale_x_discrete(labels=c("Rewarded" = "Rewarded magnetic field", "Unrewarded"= "Unrewarded magnetic field")) + scale_y_continuous(expand = c(0,0),limits = c(0,81), breaks = c(0, 25, 50, 75)) +
  geom_segment(aes(x="Rewarded",xend="Unrewarded",y=77,yend=77)) + 
        annotate("text", x = c(1.5),y = c(77.5),label = c("*"), size=8)

cond_barplot
ggsave("FigS1.pdf", width=6, height=4, dpi=300)
```

#Statistical Analysis
```{r}
wilcox_test(Avg_Time ~ Treatment, data = cond_data, paired= TRUE, p.adjust.method = "BH", alternative = "two.sided") 
compare_means(Avg_Time ~ Treatment, data = cond_data, paired= TRUE, p.adjust.method = "BH", alternative = "two.sided") #comparing with second stats to double check, same p-values
```


################################################################################
#Parallel vs Antiparallel Pulse Treatment Plotting
##Figure S2
```{r}
pulsetreat_data <- pulsemag_data %>% filter(Treatment == "Pulse")
pulsetreat_data

pulsetreat_barplot <- ggplot(pulsetreat_data,aes(x=Pulse_Treatment,y=Avg_Time,fill=Pulse_Treatment)) + 
  stat_summary(fun="mean",geom="bar") + 
  stat_summary(fun=mean,fun.min = function(x) mean(x)-sd(x)/sqrt(length(x)),fun.max = function(x) mean(x) + 
  sd(x)/sqrt(length(x)), geom="errorbar",color="black", width=0.6) + 
  geom_point(position=position_jitter(width=0.2),size=3.5) + theme_classic() + 
  theme(axis.title.x = element_blank(), axis.title.y = element_text(size=12), 
        axis.text.x = element_text(size = 12, color = "black"), 
        axis.text.y = element_text(size = 12, color = "black")) +
  labs (x="Treatment", y="Time exhibiting food-seeking \n behavior (s)") + 
  scale_fill_manual(values=c("#8C96C6", "#8C96C6")) + 
  theme(legend.position = "none") +
  scale_x_discrete(limits=c("Parallel", "Antiparallel")) + scale_y_continuous(expand = c(0,0),limits = c(0,81), breaks = c(0, 25, 50, 75))

pulsetreat_barplot
ggsave("FigS2.pdf", width=6, height=4, dpi=300)
```
##Statistical Analysis
```{r}
wilcox_test(Avg_Time ~ Pulse_Treatment, data = pulsetreat_data) 
compare_means(Avg_Time ~ Pulse_Treatment, data = pulsetreat_data) #comparing with second stats to double check, same p-value
#p-value = 0.51
```

################################################################################
#Pulse Treatments Plotting
##Figure S3
```{r}
pulsemag_barplot <- ggplot(pulsemag_data,aes(x=Treatment,y=Avg_Time,fill=Treatment)) + 
  stat_summary(fun="mean",geom="bar") + 
  stat_summary(fun=mean,fun.min = function(x) mean(x)-sd(x)/sqrt(length(x)),fun.max = function(x) mean(x) + 
  sd(x)/sqrt(length(x)), geom="errorbar",color="black", width=0.6) + 
  geom_point(position=position_jitter(width=0.2),size=3.5) + theme_classic() + 
  theme(axis.title.x = element_blank(), axis.title.y = element_text(size=12), 
        axis.text.x = element_text(size = 12, color = "black"), 
        axis.text.y = element_text(size = 12, color = "black")) +
  labs (x="Treatment", y="Time exhibiting food-seeking \n behavior (s)") + 
  scale_fill_manual(values=c("#6E016B", "#8C96C6", "#88419D")) + 
  theme(legend.position = "none") +
  scale_x_discrete(limits= c("No Pulse", "Sham Pulse", "Pulse"), labels=c("No Pulse" = "No pulse", "Sham Pulse"= "Sham pulse", "Pulse")) + 
  scale_y_continuous(expand = c(0,0),limits = c(0,81), breaks = c(0, 25, 50, 75)) +
  geom_segment(aes(x="No Pulse",xend="Pulse",y=78,yend=78)) + 
        annotate("text", x = c(2),y = c(78.5),label = c("*"), size=8) +
  geom_segment(aes(x="Sham Pulse",xend="Pulse",y=74,yend=74)) + 
        annotate("text", x = c(2.5),y = c(74.5),label = c("*"), size=8)

pulsemag_barplot
ggsave("FigS3.pdf", width=6, height=4, dpi=300)
```
##Statistical Analysis
```{r}
kruskal_test(Avg_Time ~ Treatment, data = pulsemag_data)
#p-value = 0.00465
wilcox_test(Avg_Time ~ Treatment, data = pulsemag_data, paired= TRUE, p.adjust.method = "BH") 
```

################################################################################
#Map Plot
##Figure 1A
```{r}
map_points <- read.table("03_13_24 Map Plot.csv", sep = ",", header = TRUE)

world <- map_data("world")
map <- ggplot() + geom_polygon(data=world, aes(x=long, y=lat, group=group),color="black", fill="grey" ) + 
  coord_fixed(xlim=c(-95.5, -65.5), ylim = c(15, 45), ratio = 1) + 
  theme_classic() + theme(legend.position = "none") +
        theme(axis.title.x = element_blank(),axis.text.x = element_blank(), axis.ticks.x = element_blank()) + 
        theme(axis.title.y = element_blank(),axis.text.y = element_blank(),axis.ticks.y = element_blank()) + 
        theme(panel.background = element_rect(fill = "#9EBCDA")) + 
  geom_point(data=map_points, aes(x=Longitude, y=Latitude, fill = Location), pch=21, size=5,stroke= 1.2, alpha=I(1)) +
  scale_fill_manual(values=c("white","white", "black")) + 
      annotate("text", x = c(-71.8), y = c(23.6),label = c("TC"), size=4) + 
      annotate("text", x = c(-72.3), y = c(16.9), label = c("HT"), size=4) + 
      annotate("text", x = c(-83), y = c(35.9), label = c("Test site"), size=4)
map
ggsave("Fig1A.pdf", width=4, height=4, dpi=300)

```




